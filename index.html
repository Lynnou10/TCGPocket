<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="./styles.css">
  </head>
  <body>

    <div id="app"></div>

    <script type="text/babel">
        const missingCardsRequest = fetch('./output/missing_cards.json').then((response) => response.json());
        const tradeCardsRequest = fetch('./output/trade_cards.json').then((response) => response.json());
        const recycleCardsRequest = fetch('./output/recycle_cards.json').then((response) => response.json());
        
        // GLOBALS
        const cardsBaseUrl = 'https://assets.tcgdex.net/';
        const tradeThreshold = 6;
        const getSetFromCards = (setName) => setName.split(' (')[1].replace(')', '');
        const getCardUrl = (set, cardId, language) => `${cardsBaseUrl}/${language}/tcgp/${set}/${getCardNumberForDisplay(cardId)}/low.png`;
        const isSetInCardsCollection = (cardsCollection, setKey) => Object.keys(cardsCollection).includes(setKey);
        const isRecycleCardTradeble = (recycleCard) => {
            if(recycleCard.rarityOrder < 5) {
                return recycleCard.trade_quantity > recycleCard.quantity;
            }
            return true;
        };
        const getCardNumberForDisplay = (cardNumber) => cardNumber < 10 ? `00${cardNumber}` : cardNumber < 100 ? `0${cardNumber}` : cardNumber;
        const calculateTotalTradePoint = (cards) => Object.keys(cards).map(set => cards[set].cards.map(card => card.tradeCost).reduce((previousValue, currentValue) => previousValue + currentValue,0)).reduce((previousValue, currentValue) => previousValue + currentValue,0);
        const formatCards = (cardsData, filters) => {
            const cards = {};
            cardsData.forEach((card) => {
                if(filterCard(card, filters)) {
                    const setKey = getSetFromCards(card.set)
                    
                    card.displayName = filters && filters.language == 'en' ? card.name : card.french_name ;
                    card.packDisplayName = filters && filters.language == 'en' ? card.pack : card.pack_french_name;
                    card.language = filters && filters.language === 'en' ? 'en' : 'fr' ;
                    
                    if(isSetInCardsCollection(cards, setKey)) {
                        cards[setKey].cards.push(card);
                    } else {
                        cards[setKey] = {
                            setName: card.set,
                            cards: [card]
                        };
                    }
                }
            });
            return cards
        };
        const filterCard = (card, filters) => {
            const conditions = [true]
            if(filters) {
                if(filters.fullyMissing) {
                    conditions.push(card.quantity === 0);
                }
                if(!filters.oneDiamond && card.rarityOrder === 1) {
                    conditions.push(false);
                }
                if(!filters.twoDiamonds && card.rarityOrder === 2) {
                    conditions.push(false);
                }
                if(!filters.threeDiamonds && card.rarityOrder === 3) {
                    conditions.push(false);
                }
                if(!filters.fourDiamonds && card.rarityOrder === 4) {
                    conditions.push(false);
                }
                if(!filters.oneStar && card.rarityOrder === 5) {
                    conditions.push(false);
                }
                if(!filters.veryRare && card.rarityOrder >= tradeThreshold) {
                    conditions.push(false);
                }
                return conditions.reduce(
                    (previousValue, currentValue) => previousValue && currentValue,
                    true
                );
            } else {
                return true
            }
        };
        const CheckBoxfilter = (checkBoxfilterProps) => {
            const {label, value, handleChange, filterName} = checkBoxfilterProps;
            return (
                <div className="filter">
                    <label>
                        {label}:
                        <input
                        type="checkbox"
                        checked={value}
                        onChange={() => handleChange(filterName, !value)}
                        />
                    </label>
                </div>
            )
        };
        const Selectfilter = (selectfilterProps) => {
            const {label, value, options, handleChange, filterName} = selectfilterProps;
            return (
                <div className="filter">
                    {label} :
                    <select onChange={(e) => handleChange(filterName, e.target.value)} value={value}>
                        {options.map(option => <option key={option.value} value={option.value}>{option.label}</option>)}
                    </select>
                </div>
            )
        };
        const Filters = (filtersProps) => {
            const {init, refresh, hide} = filtersProps;
            const [filters, setFilters] = React.useState({
                fullyMissing: false,
                oneDiamond: true,
                twoDiamonds: true,
                threeDiamonds: true,
                fourDiamonds: true,
                oneStar: true,
                veryRare: true,
                language: 'fr'
            });

            const handleChange = (filterName, filterValue) => {
                const newFilters = {
                    ...filters
                };
                newFilters[filterName] = filterValue
                setFilters(newFilters)
                refresh(newFilters)
            };

            return (
                <div className="filters">
                    <div>
                        {hide && hide.fullyMissing ? <></> : <CheckBoxfilter label='Only missing' value={filters.fullyMissing} filterName='fullyMissing' handleChange={handleChange}/>}
                        {hide && hide.oneDiamond ? <></> : <CheckBoxfilter label='&#9830;' value={filters.oneDiamond} filterName='oneDiamond' handleChange={handleChange}/>}
                        {hide && hide.twoDiamonds ? <></> : <CheckBoxfilter label='&#9830;&#9830;' value={filters.twoDiamonds} filterName='twoDiamonds' handleChange={handleChange}/>}
                        <CheckBoxfilter label='&#9830;&#9830;&#9830;' value={filters.threeDiamonds} filterName='threeDiamonds' handleChange={handleChange}/>
                        <CheckBoxfilter label='&#9830;&#9830;&#9830;&#9830;' value={filters.fourDiamonds} filterName='fourDiamonds' handleChange={handleChange}/>
                        <CheckBoxfilter label='&#11088;' value={filters.oneStar} filterName='oneStar' handleChange={handleChange}/>
                        {hide && hide.veryRare ? <></> : <CheckBoxfilter label='&#10024;' value={filters.veryRare} filterName='veryRare' handleChange={handleChange}/>}
                        <Selectfilter
                            label='Card language'
                            value={filters.language}
                            filterName='language'
                            options={[{label: 'English', value: 'en'}, {label: 'French', value: 'fr'}]}
                            handleChange={handleChange}/>
                    </div>
                </div>
            )
        };

        const App = (appProps) => {
            const { missingCards, tradeCards, recycleCards} = appProps
            const [page, setPage] = React.useState('missing');

            return (
                <div>
                    <div className="menu">
                        <button onClick={() => setPage('missing')}>Missing Cards</button>
                        <button onClick={() => setPage('trade')}>Trade Cards</button>
                        <button onClick={() => setPage('recycle')}>Recycle Cards</button>
                    </div>
                    { 
                        page === 'missing' ? <MissingCardsDashboard cards={missingCards}/> :
                        page === 'trade' ? <TradeCardsDashboard cards={tradeCards}/> :
                        <RecycleCardsDashboard cards={recycleCards}/>
                    }
                </div>
            ); 
        };
        // **********

        //MISSING CARDS
        const MissingCard = (cardProps) => {
            const {set, missingCard} = cardProps;
            return (
                <div className="card">
                    <div className="card-image">
                        <img
                            src={getCardUrl(set, missingCard.card_id, missingCard.language)}
                        />
                    </div>
                    <div className="card-name">
                        {missingCard.card_id} - {missingCard.displayName}
                    </div>
                    <div className="card-costs">
                        <div className="trade">Trade: {missingCard.tradeCost}</div>
                        <div className="pack">Pack points: {missingCard.pointCost}</div>
                    </div>
                    <div className="card-counter">
                        {missingCard.quantity}
                    </div>
                    <div className="card-pack-name">
                        {missingCard.packDisplayName}
                    </div>
                </div>
            )
        };

        const MissingCards = (cardsProps) => {
            const {missingCards} = cardsProps;
            return (
                <div key="missing-cards">
                    <div className="total-trade-points">Total trade points required: <strong>{calculateTotalTradePoint(missingCards)}</strong></div>
                    {
                        Object.keys(missingCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className="set-name">{missingCards[set].setName}</div>
                                {
                                    missingCards[set].cards.map(
                                        missingCard => <MissingCard
                                            key={`${set}-${missingCard.card_id}`}
                                            set={set}
                                            missingCard={missingCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const MissingCardsDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [missingCards, setMissingCards] = React.useState(() => formatCards(cards));

            return (
                <div>
                    <div className="page-title">Missing cards</div>
                    <Filters 
                        refresh={(filters) => setMissingCards(formatCards(cards, filters))}
                        hide={{veryRare: true}}
                    />
                    <MissingCards missingCards={missingCards}/>
                </div>
            )
        };
        // **********

        //TRADE CARDS
        const TradeCard = (cardProps) => {
            const {set, tradeCard} = cardProps;
            return (
                <div className="card">
                    <div className="card-image">
                        <img
                            src={getCardUrl(set, tradeCard.card_id, tradeCard.language)}
                        />
                    </div>
                    <div className="card-name">
                        {tradeCard.card_id} - {tradeCard.displayName}
                    </div>
                    <div className="card-counter">
                        {tradeCard.quantity}
                    </div>
                </div>
            )
        };

        const TradeCards = (cardsProps) => {
            const {tradeCards} = cardsProps;
            return (
                <div key="trade-cards">
                    {
                        Object.keys(tradeCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className="set-name">{tradeCards[set].setName}</div>
                                {
                                    tradeCards[set].cards.map(
                                        tradeCard => <TradeCard
                                            key={`${set}-${tradeCard.card_id}`}
                                            set={set}
                                            tradeCard={tradeCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const TradeCardsDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [tradeCards, setTradeCards] = React.useState(() => formatCards(cards));

            return (
                <div>
                    <div className="page-title">Trade cards</div>
                    <Filters
                        refresh={(filters) => setTradeCards(formatCards(cards, filters))}
                        hide={{fullyMissing: true, oneDiamond: true, twoDiamonds: true, veryRare: true}}
                    />
                    <TradeCards tradeCards={tradeCards}/>
                </div>
            )
        };
        // **********

        //RECYCLE CARDS
        const RecycleCard = (cardProps) => {
            const {set, recycleCard} = cardProps;
            return (
                <div className="card">
                    <div className={`card-image ${isRecycleCardTradeble(recycleCard) ? 'recyclable-tradable' : ''}`}>
                        <img
                            src={getCardUrl(set, recycleCard.card_id, recycleCard.language)}
                        />
                    </div>
                    <div className="card-name">
                        {recycleCard.card_id} - {recycleCard.displayName}
                    </div>
                    <div className="card-costs">
                        <div className="trade">Tokens: {recycleCard.recycle}</div>
                        <div className="pack">Total: {recycleCard.total}</div>
                    </div>
                    <div className="card-counter">
                        {recycleCard.quantity}
                    </div>
                </div>
            )
        };

        const RecycleCards = (cardsProps) => {
            const {recycleCards} = cardsProps;
            return (
                <div key="trade-cards">
                    {
                        Object.keys(recycleCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className="set-name">{recycleCards[set].setName}</div>
                                {
                                    recycleCards[set].cards.map(
                                        recycleCard => <RecycleCard
                                            key={`${set}-${recycleCard.card_id}`}
                                            set={set}
                                            recycleCard={recycleCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const RecycleCardsDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [recycleCards, setRecycleCards] = React.useState(() => formatCards(cards));

            return (
                <div>
                    <div className="page-title">Recycle cards</div>
                    <Filters
                        refresh={(filters) => setRecycleCards(formatCards(cards, filters))}
                        hide={{fullyMissing: true, oneDiamond: true, twoDiamonds: true}}
                    />
                    <RecycleCards recycleCards={recycleCards}/>
                </div>
            )
        };
        // **********

        const container = document.getElementById('app');
        const root = ReactDOM.createRoot(container);

        Promise.all([missingCardsRequest, tradeCardsRequest, recycleCardsRequest]).then((results) => {
            root.render(<App missingCards={results[0]} tradeCards={results[1]} recycleCards={results[2]}/>)
        }).catch(function(err) {
            console.log(err);
        })
       
    </script>
  </body>
</html>