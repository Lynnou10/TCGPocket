<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="./styles.css">
  </head>
  <body>

    <div id="app"></div>

    <script type="text/babel">
        const missingCardsRequest = fetch('./output/missing_cards.json').then((response) => response.json());
        const tradeCardsRequest = fetch('./output/trade_cards.json').then((response) => response.json());
        
        // GLOBALS
        const cardsBaseUrl = 'https://limitlesstcg.nyc3.cdn.digitaloceanspaces.com/pocket';
        const getSetFromCards = (setName) => setName.split(' (')[1].replace(')', '');
        const isSetInCardsCollection = (cardsCollection, setKey) => Object.keys(cardsCollection).includes(setKey);
        const getCardNumberForDisplay = (cardNumber) => cardNumber < 10 ? `00${cardNumber}` : cardNumber < 100 ? `0${cardNumber}` : cardNumber;
        const calculateTotalTradePoint = (cards) => Object.keys(cards).map(set => cards[set].cards.map(card => card.tradeCost).reduce((previousValue, currentValue) => previousValue + currentValue,0)).reduce((previousValue, currentValue) => previousValue + currentValue,0);
        const formatCards = (cardsData, filters) => {
            const cards = {};
            cardsData.forEach((card) => {
                if(filterCard(card, filters)) {
                    const setKey = getSetFromCards(card.set)
                    if(isSetInCardsCollection(cards, setKey)) {
                        cards[setKey].cards.push(card);
                    } else {
                        cards[setKey] = {
                            setName: card.set,
                            cards: [card]
                        };
                    }
                }
            });
            return cards
        };
        const filterCard = (card, filters) => {
            const conditions = [true]
            if(filters) {
                if(filters.fullyMissing) {
                    conditions.push(card.quantity === 0);
                }
                if(!filters.oneDiamond && card.rarityOrder === 1) {
                    conditions.push(false);
                }
                if(!filters.twoDiamonds && card.rarityOrder === 2) {
                    conditions.push(false);
                }
                if(!filters.threeDiamonds && card.rarityOrder === 3) {
                    conditions.push(false);
                }
                if(!filters.fourDiamonds && card.rarityOrder === 4) {
                    conditions.push(false);
                }
                if(!filters.oneStar && card.rarityOrder === 5) {
                    conditions.push(false);
                }
                return conditions.reduce(
                    (previousValue, currentValue) => previousValue && currentValue,
                    true
                );
            } else {
                return true
            }
        };
        const CheckBoxfilter = (checkBoxfilterProps) => {
            const {label, value, handleChange, filterName} = checkBoxfilterProps;
            return (
                <div className="filter">
                    <label>
                        {label}:
                        <input
                        type="checkbox"
                        checked={value}
                        onChange={() => handleChange(filterName, !value)}
                        />
                    </label>
                </div>
            )
        };
        const Filters = (filtersProps) => {
            const {init, refresh, hide} = filtersProps;
            const [filters, setFilters] = React.useState({
                fullyMissing: false,
                oneDiamond: true,
                twoDiamonds: true,
                threeDiamonds: true,
                fourDiamonds: true,
                oneStar: true
            });

            const handleChange = (filterName, filterValue) => {
                const newFilters = {
                    ...filters
                };
                newFilters[filterName] = filterValue
                setFilters(newFilters)
                refresh(newFilters)
            };

            return (
                <div className="filters">
                    {hide && hide.fullyMissing ? <></> : <CheckBoxfilter label='Only missing' value={filters.fullyMissing} filterName='fullyMissing' handleChange={handleChange}/>}
                    {hide && hide.oneDiamond ? <></> : <CheckBoxfilter label='&#9830;' value={filters.oneDiamond} filterName='oneDiamond' handleChange={handleChange}/>}
                    {hide && hide.twoDiamonds ? <></> : <CheckBoxfilter label='&#9830;&#9830;' value={filters.twoDiamonds} filterName='twoDiamonds' handleChange={handleChange}/>}
                    <CheckBoxfilter label='&#9830;&#9830;&#9830;' value={filters.threeDiamonds} filterName='threeDiamonds' handleChange={handleChange}/>
                    <CheckBoxfilter label='&#9830;&#9830;&#9830;&#9830;' value={filters.fourDiamonds} filterName='fourDiamonds' handleChange={handleChange}/>
                    <CheckBoxfilter label='&#11088;' value={filters.oneStar} filterName='oneStar' handleChange={handleChange}/>
                </div>
            )
        };

        const App = (appProps) => {
            const { missingCards, tradeCards} = appProps
            const [page, setPage] = React.useState('missing');

            return (
                <div>
                    <div className="menu">
                        <button onClick={() => setPage('missing')}>Missing Cards</button>
                        <button onClick={() => setPage('trade')}>Trade Cards</button>
                    </div>
                    { page === 'missing' ? <MissingCardsDashboard cards={missingCards}/> : page === 'trade' ? <TradeCardsDashboard cards={tradeCards}/> : <div>TEMP</div>}
                </div>
            ); 
        };
        // **********

        //MISSING CARDS
        const MissingCard = (cardProps) => {
            const {set, missingCard} = cardProps;
            return (
                <div className="card">
                    <div className="card-image">
                        <img
                            src={`${cardsBaseUrl}/${set}/${set}_${getCardNumberForDisplay(missingCard.card_id)}_EN.webp`}
                        />
                    </div>
                    <div className="card-name">
                        {missingCard.card_id} - {missingCard.name}
                    </div>
                    <div className="card-costs">
                        <div className="trade">Echange: {missingCard.tradeCost}</div>
                        <div className="pack">Pack points: {missingCard.pointCost}</div>
                    </div>
                    <div className="card-counter">
                        {missingCard.quantity}
                    </div>
                    <div className="card-pack-name">
                        {missingCard.pack}
                    </div>
                </div>
            )
        };

        const MissingCards = (cardsProps) => {
            const {missingCards} = cardsProps;
            return (
                <div key="missing-cards">
                    <div className="total-trade-points">Total trade points required: <strong>{calculateTotalTradePoint(missingCards)}</strong></div>
                    {
                        Object.keys(missingCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className="set-name">{missingCards[set].setName}</div>
                                {
                                    missingCards[set].cards.map(
                                        missingCard => <MissingCard
                                            key={`${set}-${missingCard.card_id}`}
                                            set={set}
                                            missingCard={missingCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const MissingCardsDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [missingCards, setMissingCards] = React.useState(formatCards(cards));

            return (
                <div>
                    <div className="page-title">Missing cards</div>
                    <Filters refresh={(filters) => setMissingCards(formatCards(cards, filters))}/>
                    <MissingCards missingCards={missingCards}/>
                </div>
            )
        };
        // **********

        //TRADE CARDS
        const TradeCard = (cardProps) => {
            const {set, tradeCard} = cardProps;
            return (
                <div className="card">
                    <div className="card-image">
                        <img
                            src={`${cardsBaseUrl}/${set}/${set}_${getCardNumberForDisplay(tradeCard.card_id)}_EN.webp`}
                        />
                    </div>
                    <div className="card-name">
                        {tradeCard.card_id} - {tradeCard.name}
                    </div>
                    <div className="card-counter">
                        {tradeCard.quantity}
                    </div>
                </div>
            )
        };

        const TradeCards = (cardsProps) => {
            const {tradeCards} = cardsProps;
            return (
                <div key="trade-cards">
                    {
                        Object.keys(tradeCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className="set-name">{tradeCards[set].setName}</div>
                                {
                                    tradeCards[set].cards.map(
                                        tradeCard => <TradeCard
                                            key={`${set}-${tradeCard.card_id}`}
                                            set={set}
                                            tradeCard={tradeCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const TradeCardsDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [filters, setFilters] = React.useState({});
            const [tradeCards, setTradeCards] = React.useState(formatCards(cards));

            return (
                <div>
                    <div className="page-title">Trade cards</div>
                    <Filters
                        refresh={(filters) => setTradeCards(formatCards(cards, filters))}
                        hide={{fullyMissing: true, oneDiamond: true, twoDiamonds: true}}
                    />
                    <TradeCards tradeCards={tradeCards}/>
                </div>
            )
        };
        // **********

        const container = document.getElementById('app');
        const root = ReactDOM.createRoot(container);

        Promise.all([missingCardsRequest, tradeCardsRequest]).then((results) => {
            root.render(<App missingCards={results[0]} tradeCards={results[1]}/>)
        }).catch(function(err) {
            console.log(err);
        })
       
    </script>
  </body>
</html>