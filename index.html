<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="./styles.css">
  </head>
  <body>

    <div id="app"></div>

    <script type="text/babel">
        const collectionRequest = fetch('./output/collection.json', {cache: "no-store"}).then((response) => response.json());
        const missingCardsRequest = fetch('./output/missing_cards.json', {cache: "no-store"}).then((response) => response.json());
        const tradeCardsRequest = fetch('./output/trade_cards.json', {cache: "no-store"}).then((response) => response.json());
        const recycleCardsRequest = fetch('./output/recycle_cards.json', {cache: "no-store"}).then((response) => response.json());
        
    // GLOBALS
        // CONFIGUTRATION
        document.addEventListener('contextmenu', event => event.preventDefault());

        // VARIABLES
        const cardsBaseUrl = 'https://assets.tcgdex.net/';
        const tradeThreshold = 6;
        const promos = ['PA'];
        let lastExtension = '';

        // FUNCTIONS
        const getSetFromCards = (setName) => {
            if(setName.includes("(")) {
                return setName.split(' (')[1].replace(')', '');
            }
            else {
                return setName;
            }
        };
        const setLastExtension = (collection) => {
            let extensions = [...new Set(collection.map(card => card.set_id))].sort();
            extensions = extensions.filter(extension => !promos.includes(extension));
            lastExtension = extensions[extensions.length -1]
        };
        const getCardUrl = (set, cardId, language) => `${cardsBaseUrl}/${language}/tcgp/${set.replace('romo', '')}/${getCardNumberForDisplay(cardId)}/low.png`;
        const isKeyInCardsCollection = (cardsCollection, key) => Object.keys(cardsCollection).includes(key);
        const isRecycleCardTradeble = (recycleCard) => {
            if(recycleCard.rarityOrder < 5) {
                return recycleCard.trade_quantity > recycleCard.quantity;
            }
            return true;
        };
        const getCardNumberForDisplay = (cardNumber) => cardNumber < 10 ? `00${cardNumber}` : cardNumber < 100 ? `0${cardNumber}` : cardNumber;
        const calculateTotalTradePoint = (cards) => Object.keys(cards).map(set => cards[set].cards.map(card => card.tradeCost).reduce((previousValue, currentValue) => previousValue + currentValue,0)).reduce((previousValue, currentValue) => previousValue + currentValue,0);
        const formatCards = (cardsData, filters) => {
            const cards = {};
            cardsData.forEach((card) => {
                if(filterCard(card, filters)) {
                    const setKey = getSetFromCards(card.set)
                    
                    card.displayName = filters && filters.language == 'en' ? card.name : card.french_name ;
                    card.packDisplayName = filters && filters.language == 'en' ? card.pack : card.pack_french_name;
                    card.language = filters && filters.language === 'en' ? 'en' : 'fr' ;
                    
                    if(isKeyInCardsCollection(cards, setKey)) {
                        cards[setKey].cards.push(card);
                    } else {
                        cards[setKey] = {
                            setName: card.set,
                            cards: [card]
                        };
                    }
                }
            });
            return cards
        };
        const filterCard = (card, filters) => {
            const conditions = [true]
            if(filters) {
                if(filters.fullyMissing) {
                    conditions.push(card.quantity === 0);
                }
                if(!filters.oneDiamond && card.rarityOrder === 1) {
                    conditions.push(false);
                }
                if(!filters.twoDiamonds && card.rarityOrder === 2) {
                    conditions.push(false);
                }
                if(!filters.threeDiamonds && card.rarityOrder === 3) {
                    conditions.push(false);
                }
                if(!filters.fourDiamonds && card.rarityOrder === 4) {
                    conditions.push(false);
                }
                if(!filters.oneStar && card.rarityOrder === 5) {
                    conditions.push(false);
                }
                if(!filters.veryRare && card.rarityOrder >= tradeThreshold) {
                    conditions.push(false);
                }
                if(!filters.lastExtension) {
                    conditions.push(!card.set.includes(lastExtension));
                }
                return conditions.reduce(
                    (previousValue, currentValue) => previousValue && currentValue,
                    true
                );
            } else {
                return true
            }
        };
       
        // COMPONENTS
        const ContentToClipboard = (contentToClipboardProps) => {
            const {content} = contentToClipboardProps;
            const [showMessage, setShowMessage] = React.useState(false);

            return (
                <div className="copy-clipboard">
                    {showMessage ? <span>Cards copied to clipboard!</span> : <></>}
                    <button onClick={() => {
                        navigator.clipboard.writeText(content).then(function() {
                            setShowMessage(true);
                            setTimeout(() => setShowMessage(false), 3000);
                        }, function(err) {
                            console.error('Could not copy text: ', err);
                        });
                    }}>
                        &#128203;
                    </button>
                </div>
            )
            // 
            // COPY
        };
        const SetHider = (hiderProps) => {
            const {set, hideSet, setHideSet, defaultOpened} = hiderProps;

            return (
                <div className="hide-set">
                    <button onClick={() => {
                        let value = true;
                        if(defaultOpened) {
                            value = false;
                        }
                        setHideSet({...hideSet, [set]: value});
                    }}>{defaultOpened ? <span>&#11167;</span> : <span>&#11165;</span>}</button>
                </div>
            )

        };
        const CheckBoxfilter = (checkBoxfilterProps) => {
            const {label, value, handleChange, filterName} = checkBoxfilterProps;
            return (
                <div className="filter">
                    <label>
                        {label}
                        <input
                        type="checkbox"
                        checked={value}
                        onChange={() => handleChange(filterName, !value)}
                        />
                    </label>
                </div>
            )
        };
        const Selectfilter = (selectfilterProps) => {
            const {label, value, options, handleChange, filterName} = selectfilterProps;
            return (
                <div className="filter">
                    {label}:&nbsp;
                    <select onChange={(e) => handleChange(filterName, e.target.value)} value={value}>
                        {options.map(option => <option key={option.value} value={option.value}>{option.label}</option>)}
                    </select>
                </div>
            )
        };
        const Filters = (filtersProps) => {
            const {init, refresh, show} = filtersProps;
            const [filters, setFilters] = React.useState({
                fullyMissing: false,
                oneDiamond: true,
                twoDiamonds: true,
                threeDiamonds: true,
                fourDiamonds: true,
                oneStar: true,
                veryRare: true,
                language: 'fr',
                lastExtension: true
            });

            const handleChange = (filterName, filterValue) => {
                const newFilters = {
                    ...filters
                };
                newFilters[filterName] = filterValue
                setFilters(newFilters)
                refresh(newFilters)
            };

            return (
                <div className="filters">
                    <div>
                        {show && show.fullyMissing ? <CheckBoxfilter label='Only missing' value={filters.fullyMissing} filterName='fullyMissing' handleChange={handleChange}/> : <></>}
                        {show && show.oneDiamond ? <CheckBoxfilter label='&#9830;' value={filters.oneDiamond} filterName='oneDiamond' handleChange={handleChange}/> : <></>}
                        {show && show.twoDiamonds ? <CheckBoxfilter label='&#9830;&#9830;' value={filters.twoDiamonds} filterName='twoDiamonds' handleChange={handleChange}/> : <></>}
                        {show && show.threeDiamonds ? <CheckBoxfilter label='&#9830;&#9830;&#9830;' value={filters.threeDiamonds} filterName='threeDiamonds' handleChange={handleChange}/> : <></>}
                        {show && show.fourDiamonds ? <CheckBoxfilter label='&#9830;&#9830;&#9830;&#9830;' value={filters.fourDiamonds} filterName='fourDiamonds' handleChange={handleChange}/> : <></>}
                        {show && show.oneStar ? <CheckBoxfilter label='&#11088;' value={filters.oneStar} filterName='oneStar' handleChange={handleChange}/> : <></>}
                        {show && show.veryRare ? <CheckBoxfilter label='&#10024;' value={filters.veryRare} filterName='veryRare' handleChange={handleChange}/> : <></>}
                        {show && show.lastExtension ? <CheckBoxfilter label='Last extension' value={filters.lastExtension} filterName='lastExtension' handleChange={handleChange}/> : <></>}
                        {show && show.language ? <Selectfilter
                            label='Language'
                            value={filters.language}
                            filterName='language'
                            options={[{label: 'English', value: 'en'}, {label: 'French', value: 'fr'}]}
                            handleChange={handleChange}/>  : <></>
                        }
                    </div>
                </div>
            )
        };
        const App = (appProps) => {
            const { collection, missingCards, tradeCards, recycleCards} = appProps
            const [page, setPage] = React.useState('Collection');

            return (
                <div className="content">
                    <div className="menu">
                        <div className="page-title">{page}</div>
                        <button onClick={() => setPage('Collection')}>Collection</button>
                        <button onClick={() => setPage('Missing Cards')}>Missing Cards</button>
                        <button onClick={() => setPage('Trade Cards')}>Trade Cards</button>
                        <button onClick={() => setPage('Recycle Cards')}>Recycle Cards</button>
                    </div>
                    { 
                        page === 'Missing Cards' ? <MissingCardsDashboard cards={missingCards}/> :
                        page === 'Trade Cards' ? <TradeCardsDashboard cards={tradeCards}/> :
                        page === 'Recycle Cards' ? <RecycleCardsDashboard cards={recycleCards}/> :
                        <CollectionDashboard cards={collection}/>
                    }
                </div>
            ); 
        };
    // **********

    // APP COMPONENTS
        //MISSING CARDS
        const MissingCardsByPack = (missingCardsProps) => {
            const packMissingCard = {};
            let allPacksValue = 0;
            missingCardsProps.setMissingCards.forEach((card) => { 
                if(card.packDisplayName === 'All') {
                    allPacksValue += 1;
                } else {
                    if(isKeyInCardsCollection(packMissingCard, card.packDisplayName)) {
                        packMissingCard[card.packDisplayName] += 1;
                    } else {
                        packMissingCard[card.packDisplayName] = 1
                    }
                }
            });
            return (<div className="set-info">
                <div>Cards: <strong>{missingCardsProps.setMissingCards.length}</strong></div>
                {
                    Object.keys(packMissingCard).map(pack => <div key={pack}>{pack} : <strong>{packMissingCard[pack] + allPacksValue}</strong></div>)
                }
            </div>)
        };

        const MissingCard = (cardProps) => {
            const {set, missingCard} = cardProps;
            return (
                <div className="card">
                    <div className="card-image">
                        <img
                            src={getCardUrl(set, missingCard.card_id, missingCard.language)}
                        />
                    </div>
                    <div className="card-name">
                        {missingCard.card_id} - {missingCard.displayName}
                    </div>
                    <div className="card-costs">
                        <div className="trade">Trade: {missingCard.tradeCost}</div>
                        <div className="pack">Pack points: {missingCard.pointCost}</div>
                    </div>
                    <div className="card-counter">
                        {missingCard.quantity}
                    </div>
                    <div className="card-pack-name">
                        {missingCard.packDisplayName}
                    </div>
                </div>
            )
        };

        const MissingCards = (cardsProps) => {
            const {missingCards} = cardsProps;
            const [hideSet, setHideSet] = React.useState({});

            return (
                <div key="missing-cards">
                    <div className="global-stats">
                        <div className="global-stats-element">Cards: <strong>{Object.keys(missingCards).map(set => missingCards[set].cards.length).reduce((partialSum, a) => partialSum + a, 0)}</strong></div> 
                        <div className="global-stats-element">Trade points needed: <strong>{calculateTotalTradePoint(missingCards)}</strong></div> 
                    </div>
                    {
                        Object.keys(missingCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className = "set-container">
                                    <div className="set-name">{missingCards[set].setName}</div>
                                    <SetHider set={set} hideSet={hideSet} setHideSet={setHideSet} defaultOpened={!!hideSet[set]}/>
                                    <MissingCardsByPack setMissingCards={missingCards[set].cards}/>
                                </div>
                                {
                                    hideSet[set] ? 
                                        <></> : missingCards[set].cards.map(
                                        missingCard => <MissingCard
                                            key={`${set}-${missingCard.card_id}`}
                                            set={set}
                                            missingCard={missingCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const MissingCardsDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [missingCards, setMissingCards] = React.useState(() => formatCards(cards));

            return (
                <div>
                    <Filters 
                        refresh={(filters) => setMissingCards(formatCards(cards, filters))}
                        show={{
                            fullyMissing: true,
                            oneDiamond: true,
                            twoDiamonds: true,
                            threeDiamonds: true,
                            fourDiamonds: true,
                            oneStar: true,
                            language: true,
                            lastExtension: true
                        }}
                    />
                    <MissingCards missingCards={missingCards}/>
                </div>
            )
        };
        // **********

        //TRADE CARDS
        const TradeCard = (cardProps) => {
            const {set, tradeCard} = cardProps;
            return (
                <div className="card">
                    <div className="card-image">
                        <img
                            src={getCardUrl(set, tradeCard.card_id, tradeCard.language)}
                        />
                    </div>
                    <div className="card-name">
                        {tradeCard.card_id} - {tradeCard.displayName}
                    </div>
                    <div className="card-counter">
                        {tradeCard.quantity}
                    </div>
                </div>
            )
        };

        const TradeCards = (cardsProps) => {
            const {tradeCards} = cardsProps;
            const [hideSet, setHideSet] = React.useState({});

            return (
                <div key="trade-cards">
                    <ContentToClipboard
                        content={
                            Object.keys(tradeCards).sort().map(
                                set => tradeCards[set].cards.map(
                                    card => `${card.displayName} ${card.rarity} (${set})`
                                ).join('\r\n')
                            ).join('\r\n')
                        }
                    />
                    {
                        Object.keys(tradeCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className = "set-container">
                                    <div className="set-name">{tradeCards[set].setName}</div>
                                    <SetHider set={set} hideSet={hideSet} setHideSet={setHideSet} defaultOpened={!!hideSet[set]}/>
                                </div>
                                {
                                    hideSet[set] ? 
                                        <></> : tradeCards[set].cards.map(
                                        tradeCard => <TradeCard
                                            key={`${set}-${tradeCard.card_id}`}
                                            set={set}
                                            tradeCard={tradeCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const TradeCardsDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [tradeCards, setTradeCards] = React.useState(() => formatCards(cards));

            return (
                <div>
                    <Filters
                        refresh={(filters) => setTradeCards(formatCards(cards, filters))}
                        show={{
                            threeDiamonds: true,
                            fourDiamonds: true,
                            oneStar: true,
                            language: true,
                            lastExtension: true
                        }}
                    />
                    <TradeCards tradeCards={tradeCards}/>
                </div>
            )
        };
        // **********

        //RECYCLE CARDS
        const RecycleCard = (cardProps) => {
            const {set, recycleCard} = cardProps;
            return (
                <div className="card">
                    <div className={`card-image ${isRecycleCardTradeble(recycleCard) ? 'recyclable-tradable' : ''}`}>
                        <img
                            src={getCardUrl(set, recycleCard.card_id, recycleCard.language)}
                        />
                    </div>
                    <div className="card-name">
                        {recycleCard.card_id} - {recycleCard.displayName}
                    </div>
                    <div className="card-costs">
                        <div className="trade">Tokens: {recycleCard.recycle}</div>
                        <div className="pack">Total: {recycleCard.total}</div>
                    </div>
                    <div className="card-counter">
                        {recycleCard.quantity}
                    </div>
                </div>
            )
        };

        const RecycleCards = (cardsProps) => {
            const {recycleCards} = cardsProps;
            const [hideSet, setHideSet] = React.useState({});

            return (
                <div key="trade-cards">
                    <div className="global-stats">
                        <div className="global-stats-element">Available points: <strong>{
                            Object.keys(recycleCards).map(
                                set => recycleCards[set].cards.map(
                                    card => card.total
                                ).reduce((partialSum, a) => partialSum + a, 0)
                            ).reduce((partialSum, a) => partialSum + a, 0)
                        }</strong></div> 
                    </div>
                    {
                        Object.keys(recycleCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className = "set-container">
                                    <div className="set-name">{recycleCards[set].setName}</div>
                                    <SetHider set={set} hideSet={hideSet} setHideSet={setHideSet} defaultOpened={!!hideSet[set]}/>
                                </div>
                                {
                                    hideSet[set] ? 
                                        <></> : recycleCards[set].cards.map(
                                        recycleCard => <RecycleCard
                                            key={`${set}-${recycleCard.card_id}`}
                                            set={set}
                                            recycleCard={recycleCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const RecycleCardsDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [recycleCards, setRecycleCards] = React.useState(() => formatCards(cards));

            return (
                <div>
                    <Filters
                        refresh={(filters) => setRecycleCards(formatCards(cards, filters))}
                        show={{
                            threeDiamonds: true,
                            fourDiamonds: true,
                            oneStar: true,
                            veryRare: true,
                            language: true
                        }}
                    />
                    <RecycleCards recycleCards={recycleCards}/>
                </div>
            )
        };
        // **********

        //COLLECTION CARDS
        const CardsCountByPack = (cardsCountProps) => {
            const {refreshCounter, collection, set} = cardsCountProps;
            return (
                <div className="set-info">
                    Set cards count: 
                    <strong>
                        { refreshCounter > 0 ? collection[set].cards.filter(card => !(set === 'A1' && card.card_id === 283)).map(card => card.quantity).reduce((partialSum, a) => partialSum + a, 0) : 0}
                    </strong>
                </div>
            )
        };

        const CollectionCard = (cardProps) => {
            const {set, collectionCard, updateCardQuantity} = cardProps;
            const [card, setCard] = React.useState(collectionCard);

            const handleClick = (e) => {
                if (e.type === 'click') {
                    setCard({...card, quantity: card.quantity + 1})
                    updateCardQuantity(set, collectionCard.card_id, 1);
                } else if (e.type === 'contextmenu') {
                    setCard({...card, quantity: card.quantity -1})
                    updateCardQuantity(set, collectionCard.card_id, -1);
                }
            };

            return (
                <button className={`clickable-card ${card.quantity === 0 ? 'missing-card' : ''}`} onClick={handleClick} onContextMenu={handleClick}>
                    <div className="card">
                        <div className="card-image">
                            <img
                                src={getCardUrl(set, card.card_id, card.language)}
                            />
                        </div>
                        <div className="card-name">
                            {card.card_id} - {card.displayName}
                        </div>
                        <div className="card-counter">
                            {card.quantity}
                        </div>
                    </div>
                </button>
            )
        };

        const CollectionCards = (cardsProps) => {
            const {collectionCards} = cardsProps;

            const [collection, setCollection] = React.useState(collectionCards);
            const [hideSet, setHideSet] = React.useState({});
            const [showSaveCollection, setShowSaveCollection] = React.useState(false);
            const [refreshCounter, setRefreshCounter] = React.useState(1)

            const updateCardQuantity = (set, cardId, deltaQuantity) => {
                const cardIndex = collection[set].cards.findIndex(card => card.card_id === cardId);
                if (cardIndex !== undefined) {
                    collection[set].cards[cardIndex].quantity += deltaQuantity;
                }
                setCollection(collection);
                setShowSaveCollection(true);
                setRefreshCounter(refreshCounter + 1);
            };

            const saveCollection = () => 
                fetch('/collection', {
                    method: 'POST',
                    body: JSON.stringify(Object.keys(collection).map(set => collection[set].cards).flat(1))
                }).then((response) => location.reload(true));
            ;

            return (
                <div key="collection-cards">
                    {showSaveCollection ? <div className="save-collection">
                            <button onClick={saveCollection}>Save collection</button>
                        </div> : <></>
                    }
                    <div className="global-stats">
                        Total cards: 
                        <strong>
                            { refreshCounter > 0 ? Object.keys(collection).map(set => 
                                collection[set].cards.map(
                                    card => {
                                        //OLD AMBER IS IN A1 and A1A
                                        if(card.name === 'Old Amber' && set === 'A1')
                                            return 0;
                                        else{
                                            return card.quantity;
                                        }
                                    }
                                ).reduce(
                                    (partialSum, a) => partialSum + a, 0)
                                ).reduce(
                                    (partialSum, a) => partialSum + a, 0)
                                : 0}
                        </strong>
                    </div>
                    {
                        Object.keys(collection).sort().map(set => 
                            <div key={set} className="set">
                                <div className="set-container">
                                    <div className="set-name">{collection[set].setName}</div>
                                    <SetHider set={set} hideSet={hideSet} setHideSet={setHideSet} defaultOpened={!!hideSet[set] || !Object.keys(hideSet).includes(set)}/>
                                    <CardsCountByPack refreshCounter={refreshCounter} collection={collection} set={set}/>
                                </div>
                                { 
                                    hideSet[set] || !Object.keys(hideSet).includes(set) ? 
                                        <></> :
                                        collection[set].cards.map(
                                            collectionCard => <CollectionCard
                                                key={`${set}-${collectionCard.card_id}`}
                                                set={set}
                                                collectionCard={collectionCard}
                                                updateCardQuantity={updateCardQuantity}
                                            />
                                        )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const CollectionDashboard = (cardsDashboardProps) => {
            const {cards} = cardsDashboardProps;
            const [collectionCards, setCollectionCards] = React.useState(() => formatCards(cards));

            return (
                <div>
                    <Filters
                        refresh={(filters) => setCollectionCards(formatCards(cards, filters))}
                        show={{language: true}}
                    />
                    <CollectionCards collectionCards={collectionCards}/>
                </div>
            )
        };
        // **********
    // **********

        const container = document.getElementById('app');
        const root = ReactDOM.createRoot(container);

        Promise.all([collectionRequest, missingCardsRequest, tradeCardsRequest, recycleCardsRequest]).then((results) => {
            setLastExtension(results[0]);
            root.render(<App 
                collection={results[0]}
                missingCards={results[1]}
                tradeCards={results[2]}
                recycleCards={results[3]}
            />)
        }).catch(function(err) {
            console.log(err);
        })
       
    </script>
  </body>
</html>