<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="./styles.css">
  </head>
  <body>

    <div id="mydiv"></div>

    <script type="text/babel">

        let displayedMissingCards = null
        const missingCardsRequest = fetch('./output/missing_cards.json').then((response) => response.json());
        const tradeCardsRequest = fetch('./output/trade_cards.json').then((response) => response.json());
        
        // GLOBALS
        const cardsBaseUrl = 'https://limitlesstcg.nyc3.cdn.digitaloceanspaces.com/pocket';
        const getSetFromCards = (setName) => setName.split(' (')[1].replace(')', '');
        const isSetInCardsCollection = (cardsCollection, setKey) => Object.keys(cardsCollection).includes(setKey);
        const getCardNumberForDisplay = (cardNumber) => cardNumber < 10 ? `00${cardNumber}` : cardNumber < 100 ? `0${cardNumber}` : cardNumber;

        const App = () => {
            const [page, setPage] = React.useState('missing');

            return (
                <div>
                    <div className="menu">
                        <button onClick={() => setPage('missing')}>Missing cards</button>
                        <button onClick={() => setPage('trade')}>Trade Cards</button>
                    </div>
                    { page === 'missing' ? <MissingCardsDashboard/> : page === 'trade' ? <TradeCardsDashboard/> : <div>TEMP</div>}
                </div>
            ); 
        };
        // **********

        //MISSING CARDS
        let missingCardsData = [];
        
        const filterMissingCard = (missingCard, filters) => {
            if(filters.fullyMissing) {
                return missingCard.quantity === 0;
            }
            return true;
        }

        const formatMissingCards = (filters) => {
            const missingCards = {};
            missingCardsData.forEach((missingCard) => {
                if(filterMissingCard(missingCard, filters)) {
                    const setKey = getSetFromCards(missingCard.set)
                    if(isSetInCardsCollection(missingCards, setKey)) {
                        missingCards[setKey].cards.push(missingCard);
                    } else {
                        missingCards[setKey] = {
                            setName: missingCard.set,
                            cards: [missingCard]
                        };
                    }
                }
            });
            return missingCards
        }

        const MissingCard = (cardProps) => {
            return (
                <div className="card">
                    <div className="card-image">
                        <img
                            src={`${cardsBaseUrl}/${cardProps.set}/${cardProps.set}_${getCardNumberForDisplay(cardProps.missingCard.card_id)}_EN.webp`}
                        />
                    </div>
                    <div className="card-name">
                        {cardProps.missingCard.card_id} - {cardProps.missingCard.name}
                    </div>
                    <div className="card-counter">
                        {cardProps.missingCard.quantity}
                    </div>
                    <div className="card-pack-name">
                        {cardProps.missingCard.pack}
                    </div>
                </div>
            )
        };

        const MissingCards = (cardsProps) => {
            return (
                <div key="missing-cards">
                    {
                        Object.keys(cardsProps.missingCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className="set-name">{cardsProps.missingCards[set].setName}</div>
                                {
                                    cardsProps.missingCards[set].cards.map(
                                        missingCard => <MissingCard
                                            key={`${set}-${missingCard.card_id}`}
                                            set={set}
                                            missingCard={missingCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const MissingCardsHeader = (missingCardsHeaderProps) => {
            const handleChange = () => {
                missingCardsHeaderProps.filtersChange({fullyMissing: !missingCardsHeaderProps.filters.fullyMissing})
            };

            return (
                <div className="missing-filters">
                    <label>
                        Only missing: 
                        <input
                        type="checkbox"
                        checked={missingCardsHeaderProps.filters.fullyMissing}
                        onChange={handleChange}
                        />
                        
                    </label>
                </div>
            )


        };

        const MissingCardsDashboard = () => {
            const [filters, setFilters] = React.useState({
                fullyMissing: true
            });
            const [missingCards, setMissingCards] = React.useState(formatMissingCards(filters));

            const filtersChange = (newFilters) => {
                setFilters(newFilters)
                setMissingCards(formatMissingCards(newFilters))
            };

            return (
                <div>
                    <div className="page-title">Missing cards</div>
                    <MissingCardsHeader filters={filters} filtersChange={filtersChange}/>
                    <MissingCards missingCards={missingCards}/>
                </div>
            )
        };
        // **********

        //TRADE CARDS
        let tradeCardsData = [];

        const formatTradeCards = () => {
            const tradeCards = {};
            tradeCardsData.forEach((tradeCard) => {
                const setKey = getSetFromCards(tradeCard.set)
                if(isSetInCardsCollection(tradeCards, setKey)) {
                    tradeCards[setKey].cards.push(tradeCard);
                } else {
                    tradeCards[setKey] = {
                        setName: tradeCard.set,
                        cards: [tradeCard]
                    };
                }
            });
            return tradeCards
        }

        const TradeCard = (cardProps) => {
            return (
                <div className="card">
                    <div className="card-image">
                        <img
                            src={`${cardsBaseUrl}/${cardProps.set}/${cardProps.set}_${getCardNumberForDisplay(cardProps.tradeCard.card_id)}_EN.webp`}
                        />
                    </div>
                    <div className="card-name">
                        {cardProps.tradeCard.card_id} - {cardProps.tradeCard.name}
                    </div>
                    <div className="card-counter">
                        {cardProps.tradeCard.quantity}
                    </div>
                </div>
            )
        };

        const TradeCards = (cardsProps) => {
            return (
                <div key="trade-cards">
                    {
                        Object.keys(cardsProps.tradeCards).sort().map(set => 
                            <div key={set} className="set">
                                <div className="set-name">{cardsProps.tradeCards[set].setName}</div>
                                {
                                    cardsProps.tradeCards[set].cards.map(
                                        tradeCard => <TradeCard
                                            key={`${set}-${tradeCard.card_id}`}
                                            set={set}
                                            tradeCard={tradeCard}
                                        />
                                    )
                                }
                            </div> 
                        )
                    }
                </div>
            )
        };

        const TradeCardsDashboard = () => {
            const [tradeCards, setTradeCards] = React.useState(formatTradeCards());

            return (
                <div>
                    <div className="page-title">Trade cards</div>
                    <TradeCards tradeCards={tradeCards}/>
                </div>
            )
        };
        // **********

        const container = document.getElementById('mydiv');
        const root = ReactDOM.createRoot(container);

        Promise.all([missingCardsRequest, tradeCardsRequest]).then((results) => {
            missingCardsData = results[0];
            tradeCardsData = results[1];
            root.render(<App />)
        }).catch(function(err) {
            console.log(err);
        })
       
    </script>
  </body>
</html>